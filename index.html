<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pago con tarjeta - Test</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h2>Pago con tarjeta (Sandbox)</h2>

  <form id="card-form">

    <input type="text" id="cardNumber" placeholder="Número de tarjeta" value="4075595716483764" />
    <input type="text" id="cardExpirationMonth" placeholder="Mes (MM)" value="11" />
    <input type="text" id="cardExpirationYear" placeholder="Año (YYYY)" value="2030" />
    <input type="text" id="securityCode" placeholder="CVV" value="123" />
    <input type="text" id="cardholderName" placeholder="Nombre titular" value="APRO" />
    <input type="email" id="email" placeholder="Email comprador test"
      value="test_user_78520294106420@testuser.com" />
    <input type="text" id="identificationNumber" placeholder="RFC"
      value="XAXX010101000" />

    <button type="submit">Pagar</button>
  </form>

  <pre id="result"></pre>
</div>

<script src="https://sdk.mercadopago.com/js/v2"></script>

<script>
  const mp = new MercadoPago("APP_USR-5e46c9ab-e423-49ff-8f21-22203911730a"); // ⚠️ Usa PUBLIC KEY, no ACCESS TOKEN

  const form = document.getElementById("card-form");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const resultBox = document.getElementById("result");
    resultBox.textContent = "Procesando...";

    try {
      // 1️⃣ Crear token
      const tokenResponse = await mp.createCardToken({
        cardNumber: cardNumber.value,
        cardExpirationMonth: cardExpirationMonth.value,
        cardExpirationYear: cardExpirationYear.value,
        securityCode: securityCode.value,
        cardholderName: cardholderName.value,
        identificationType: "RFC",
        identificationNumber: identificationNumber.value,
        cardholderEmail: email.value,
      });

      const cardToken = tokenResponse.id;

      // 2️⃣ Enviar a tu backend INMEDIATAMENTE
      const response = await fetch(
        "https://webhooks.aspas.space/transactions/20/pay",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            transaction_id: 20,
            provider_code: "mercadopago",
            token_card: cardToken,
            payment_method_id: "visa",
            payer_email: email.value
          })
        }
      );

      const data = await response.json();

      resultBox.textContent = JSON.stringify(data, null, 2);

    } catch (error) {
      resultBox.textContent = JSON.stringify(error, null, 2);
    }
  });
</script>

</body>
</html>
